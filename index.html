<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EPSON „Éó„É™„É≥„Çø„Éº FAQ ChatBot</title>

<!-- kuroshiro „Å®Ëß£ÊûêÂô® -->
<script src="https://unpkg.com/kuroshiro/dist/kuroshiro.min.js"></script>
<script src="https://unpkg.com/kuroshiro-analyzer-kuromoji/dist/kuroshiro-analyzer-kuromoji.min.js"></script>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; padding:16px; background:#f0f0f0; }
h3 { text-align:center; }

#chat {
  max-width: 600px;
  margin: 16px auto;
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  min-height: 400px;
  overflow-y: auto;
}

input, button {
  width: calc(100% - 24px);
  padding: 12px;
  font-size: 16px;
  margin: 6px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

button {
  background: #007bff;
  color: #fff;
  border: none;
}

.message {
  margin: 8px 0;
  padding: 10px 14px;
  border-radius: 16px;
  max-width: 80%;
  word-wrap: break-word;
}

.user { background: #007bff; color: #fff; margin-left: auto; text-align: right; }
.bot { background: #f1f1f1; color: #000; margin-right: auto; }

.follow { margin-top: 4px; font-size: 14px; color: #555; }
</style>
</head>
<body>

<h3>„Éó„É™„É≥„Çø„Éº FAQ ChatBot</h3>
<div id="chat"></div>
<input id="input" placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶">
<button id="sendBtn">ÈÄÅ‰ø°</button>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1sq7O054J_6oiP-fkfCP5VCBjlgrjLMT9aXSev1ne6UE/gviz/tq?tqx=out:csv";
let data = [];
let kuro;

// KuroshiroÂàùÊúüÂåñ
async function initKuro() {
  kuro = new Kuroshiro();
  await kuro.init(new KuroshiroAnalyzerKuromoji());
}
await initKuro();

// ÊñáÂ≠óÂàóÊ≠£Ë¶èÂåñ
function normalizeLatin(str) {
  return str.toLowerCase().normalize("NFKC").replace(/[„ÉºÔºç]/g,"„Éº");
}

// „Å≤„Çâ„Åå„Å™Âåñ
async function convertToHira(str) {
  if(!str) return "";
  const tmp = normalizeLatin(str);
  try {
    const hira = await kuro.convert(tmp, { to: "hiragana", mode: "normal" });
    return hira.replace(/\s+/g,"");
  } catch(e) {
    console.warn("Â§âÊèõ„Ç®„É©„Éº", e);
    return tmp;
  }
}

// CSVË™≠„ÅøËæº„Åø + „Å≤„Çâ„Åå„Å™Âåñ„Ç≠„É£„ÉÉ„Ç∑„É•
async function loadData() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const lines = text.trim().split("\n").slice(1);
  for(const line of lines){
    const cols = line.split(",").map(c => c.replace(/^"|"$/g,""));
    const [category, question, answer, follow_up] = cols;
    const obj = { category, question, answer, follow_up };
    const fullText = category + question + answer + (follow_up||"");
    obj.hiraText = await convertToHira(fullText);
    data.push(obj);
  }
}
await loadData();

document.getElementById("sendBtn").addEventListener("click", sendMessage);
document.getElementById("input").addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(); });

async function sendMessage() {
  const inputEl = document.getElementById("input");
  const chatEl = document.getElementById("chat");
  const text = inputEl.value.trim();
  if(!text) return;

  // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
  const userMsg = document.createElement("div");
  userMsg.className = "message user";
  userMsg.textContent = text;
  chatEl.appendChild(userMsg);

  inputEl.value = "";

  // Ê§úÁ¥¢
  const words = (await convertToHira(text)).split(/\s+/);
  const hits = data.filter(d => words.every(w => d.hiraText.includes(w)));

  let botText;
  if(hits.length===0){
    botText = "Ë©≤ÂΩì„Åô„ÇãFAQ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂà•„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ";
  } else {
    botText = hits.map(d => `Q. ${d.question}\nA. ${d.answer}${d.follow_up ? "\nüí° " + d.follow_up : ""}`).join("\n\n");
  }

  const botMsg = document.createElement("div");
  botMsg.className = "message bot";
  botMsg.textContent = botText;
  chatEl.appendChild(botMsg);

  // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´
  chatEl.scrollTop = chatEl.scrollHeight;
}
</script>

</body>
</html>

