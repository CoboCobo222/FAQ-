<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EPSON FAQ ChatBot（単語部分一致版）</title>

<script src="https://unpkg.com/kuroshiro/dist/kuroshiro.min.js"></script>
<script src="https://unpkg.com/kuroshiro-analyzer-kuromoji/dist/kuroshiro-analyzer-kuromoji.min.js"></script>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; padding:16px; background:#fff; }
h3 { text-align:center; margin-bottom:12px; }

#inputArea { display:flex; gap:8px; margin-bottom:10px; }
#inputArea input { flex:1; padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc; }
#inputArea button { width:100px; padding:12px; font-size:16px; border:none; border-radius:8px; background:#007bff; color:#fff; }

#chat { height:70vh; overflow-y:auto; padding:10px; border:1px solid #ccc; border-radius:8px; background:#f7f7f7; }

.user-msg { text-align:right; margin:8px 0; }
.user-msg div { display:inline-block; background:#007bff; color:#fff; padding:8px 12px; border-radius:12px; }

.bot-msg { text-align:left; margin:8px 0; }
.bot-msg div { display:inline-block; background:#eee; color:#000; padding:8px 12px; border-radius:12px; margin-bottom:6px; }

.button-option { margin:4px 0; padding:6px 10px; border:none; border-radius:6px; background:#d0d0d0; cursor:pointer; }
.button-option:hover { background:#bbb; }
</style>
</head>
<body>

<h3>プリンター FAQ ChatBot</h3>

<div id="inputArea">
  <input id="input" placeholder="調べたい単語をいれてください…">
  <button id="sendBtn">送信</button>
</div>

<div id="chat"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1sq7O054J_6oiP-fkfCP5VCBjlgrjLMT9aXSev1ne6UE/gviz/tq?tqx=out:csv";
let data = [];
let kuro;

// ==== Kuroshiro 初期化 ====
async function initKuro() { 
  kuro = new Kuroshiro(); 
  await kuro.init(new KuroshiroAnalyzerKuromoji()); 
}
initKuro();

// ==== CSV 読み込み ====
fetch(CSV_URL).then(r=>r.text()).then(text=>{
  const lines=text.trim().split("\n").slice(1);
  data = lines.map(line=>{
    const cols=line.split(",").map(c=>c.replace(/^"|"$/g,""));
    const [category, question, answer, follow_up] = cols;
    return { category, question, answer, follow_up };
  });
});

// ==== 正規化関数 ====
async function normalize(str){
  if(!str) return "";
  let tmp = str.toLowerCase().normalize("NFKC").replace(/[ー－]/g,"ー");
  try { tmp = await kuro.convert(tmp, {to:"hiragana", mode:"normal"}); } 
  catch(e){ console.warn("変換エラー", e); }
  return tmp;
}

// ==== 文章を単語に分解 ====
async function getWords(str){
  const hira = await normalize(str);
  // ひらがな・カタカナ・アルファベット・数字の連続を単語として抽出
  return hira.match(/[\u3040-\u309F\u30A0-\u30FFA-Za-z0-9]+/g) || [];
}

// ==== 検索 & チャット表示 ====
async function search(){
  const inputEl = document.getElementById("input");
  const chatEl = document.getElementById("chat");
  const question = inputEl.value.trim();
  if(!question) return;

  // --- ユーザー吹き出し ---
  const userDiv = document.createElement("div");
  userDiv.className="user-msg";
  userDiv.innerHTML=`<div>${question}</div>`;
  chatEl.appendChild(userDiv);

  // --- 入力を単語に分解 ---
  const inputWords = await getWords(question);

  // --- CSVを検索（単語部分一致） ---
  const hits = [];
  for(const d of data){
    const textWords = await getWords(d.category + d.question + d.answer);
    // 入力の単語がCSV内のどの単語にも含まれていればヒット
    if(inputWords.some(iw => textWords.some(tw => tw.includes(iw)))) hits.push(d);
  }

  // --- Bot吹き出し ---
  const botDiv = document.createElement("div");
  botDiv.className="bot-msg";

  if(hits.length===0){
    botDiv.innerHTML=`<div>該当するFAQが見つかりませんでした。別のキーワードを試してください。</div>`;
  } else {
    botDiv.innerHTML="<div>候補を選んでください:</div>";
    hits.forEach((d,index)=>{
      const btn = document.createElement("button");
      btn.className="button-option";
      btn.textContent=d.question;
      btn.addEventListener("click",()=>{
        const answerDiv = document.createElement("div");
        answerDiv.className = "bot-msg";
        answerDiv.innerHTML = `
          <div>
            <strong>Q:</strong> ${d.question}<br>
            <strong>A:</strong> ${d.answer}
          </div>
        `;
        chatEl.appendChild(answerDiv);
        chatEl.scrollTop = chatEl.scrollHeight;
      });
      botDiv.appendChild(btn);
    });
  }

  chatEl.appendChild(botDiv);
  chatEl.scrollTop = chatEl.scrollHeight;
  inputEl.value="";
}

document.getElementById("sendBtn").addEventListener("click", search);
document.getElementById("input").addEventListener("keypress", e=>{ if(e.key==="Enter") search(); });
</script>

</body>
</html>

