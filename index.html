<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EPSON ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ FAQ ChatBot</title>

<!-- Kuroshiro ã¨è§£æå™¨ -->
<script src="https://unpkg.com/kuroshiro/dist/kuroshiro.min.js"></script>
<script src="https://unpkg.com/kuroshiro-analyzer-kuromoji/dist/kuroshiro-analyzer-kuromoji.min.js"></script>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; padding:16px; background:#f0f0f0; }
h3 { text-align:center; margin-bottom:16px; }
#chat { max-width:600px; margin:0 auto 12px; background:#fff; border-radius:12px; padding:12px; min-height:400px; overflow-y:auto; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
input, button { width:calc(100% - 24px); padding:12px; font-size:16px; margin:6px 12px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;}
button { background:#007bff; color:#fff; border:none; cursor:pointer; }
.message { margin:8px 0; padding:10px 14px; border-radius:16px; max-width:80%; word-wrap:break-word;}
.user { background:#007bff; color:#fff; margin-left:auto; text-align:right;}
.bot { background:#f1f1f1; color:#000; margin-right:auto;}
.follow { margin-top:4px; font-size:14px; color:#555;}
</style>
</head>
<body>

<h3>EPSON ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ FAQ ChatBot</h3>
<div id="chat"></div>
<input id="input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦">
<button id="sendBtn">é€ä¿¡</button>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1sq7O054J_6oiP-fkfCP5VCBjlgrjLMT9aXSev1ne6UE/gviz/tq?tqx=out:csv";

let data = [];
let kuro;

// æ–‡å­—åˆ—æ­£è¦åŒ–
function normalizeLatin(str) {
  return str.toLowerCase().normalize("NFKC").replace(/[ãƒ¼ï¼]/g,"ãƒ¼");
}

// ã²ã‚‰ãŒãªåŒ–
async function convertToHira(str) {
  if(!str) return "";
  const tmp = normalizeLatin(str);
  try {
    const hira = await kuro.convert(tmp, { to: "hiragana", mode: "normal" });
    return hira.replace(/\s+/g,"");
  } catch(e) {
    console.warn("å¤‰æ›ã‚¨ãƒ©ãƒ¼", e);
    return tmp;
  }
}

// ãƒãƒ£ãƒƒãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
function addUserMessage(text){
  const chatEl = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = "message user";
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addBotMessage(text){
  const chatEl = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = "message bot";
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

// æ¤œç´¢å‡¦ç†
async function sendMessage() {
  const inputEl = document.getElementById("input");
  const text = inputEl.value.trim();
  if(!text) return;

  addUserMessage(text);
  inputEl.value = "";

  const words = (await convertToHira(text)).split(/\s+/);
  const hits = data.filter(d => words.every(w => d.hiraText.includes(w)));

  let botText;
  if(hits.length === 0){
    botText = "è©²å½“ã™ã‚‹FAQãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚";
  } else {
    botText = hits.map(d => `Q. ${d.question}\nA. ${d.answer}${d.follow_up ? "\nğŸ’¡ " + d.follow_up : ""}`).join("\n\n");
  }

  addBotMessage(botText);
}

// åˆæœŸåŒ–é–¢æ•°
async function init() {
  // KuroshiroåˆæœŸåŒ–
  kuro = new Kuroshiro();
  await kuro.init(new KuroshiroAnalyzerKuromoji());

  // CSVèª­ã¿è¾¼ã¿ + ã²ã‚‰ãŒãªåŒ–
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const lines = text.trim().split("\n").slice(1);

  for(const line of lines){
    const cols = line.split(",").map(c => c.replace(/^"|"$/g,""));
    const [category, question, answer, follow_up] = cols;
    const obj = { category, question, answer, follow_up };
    const fullText = category + question + answer + (follow_up||"");
    obj.hiraText = await convertToHira(fullText);
    data.push(obj);
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆåˆæœŸåŒ–å®Œäº†å¾Œï¼‰
  document.getElementById("sendBtn").addEventListener("click", sendMessage);
  document.getElementById("input").addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(); });

  // åˆå›ãƒœãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  addBotMessage("ã“ã‚“ã«ã¡ã¯ï¼ãƒ—ãƒªãƒ³ã‚¿ãƒ¼FAQã§ã™ã€‚è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
window.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
