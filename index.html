<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ルールベース自由会話Bot</title>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; padding:16px; background:#fff; }
h3 { text-align:center; margin-bottom:12px; }

#inputArea { display:flex; gap:8px; margin-bottom:10px; }
#inputArea input { flex:1; padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc; }
#inputArea button { width:100px; padding:12px; font-size:16px; border:none; border-radius:8px; background:#007bff; color:#fff; }

#chat { height:70vh; overflow-y:auto; padding:10px; border:1px solid #ccc; border-radius:8px; background:#f7f7f7; }

.user-msg { text-align:right; margin:8px 0; }
.user-msg div { display:inline-block; background:#007bff; color:#fff; padding:8px 12px; border-radius:12px; }

.bot-msg { text-align:left; margin:8px 0; }
.bot-msg div { display:inline-block; background:#eee; color:#000; padding:8px 12px; border-radius:12px; margin-bottom:6px; }

.button-option { margin:4px 0; padding:6px 10px; border:none; border-radius:6px; background:#d0d0d0; cursor:pointer; }
.button-option:hover { background:#bbb; }
</style>
</head>
<body>

<h3>ルールベース自由会話Bot</h3>

<div id="inputArea">
  <input id="input" placeholder="質問を入力してください…">
  <button id="sendBtn">送信</button>
</div>

<div id="chat"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1sq7O054J_6oiP-fkfCP5VCBjlgrjLMT9aXSev1ne6UE/gviz/tq?tqx=out:csv";
let data = [];

// CSV読み込み
fetch(CSV_URL).then(r=>r.text()).then(text=>{
  const lines=text.trim().split("\n").slice(1);
  data = lines.map(line=>{
    const cols=line.split(",").map(c=>c.replace(/^"|"$/g,""));
    const [category, question, answer] = cols;
    return { category, question, answer };
  });
});

// 簡易文字正規化
function normalize(str){ return str.toLowerCase().normalize("NFKC"); }

// 簡易類似度スコア（文字列一致率）
function similarity(a,b){
  a = normalize(a); b = normalize(b);
  let match=0;
  for(let i=0;i<a.length;i++){
    if(b.includes(a[i])) match++;
  }
  return match / Math.max(a.length,b.length);
}

// 検索関数（類似度上位3件まで）
function searchFAQ(input){
  const scores = data.map(d=>({d, score:similarity(input,d.question)}));
  scores.sort((a,b)=>b.score-a.score);
  const top = scores.filter(s=>s.score>0).slice(0,3).map(s=>s.d);
  return top;
}

// チャット表示
function addChat(userText, botHTML){
  const chatEl = document.getElementById("chat");
  if(userText){
    const userDiv = document.createElement("div");
    userDiv.className="user-msg";
    userDiv.innerHTML=`<div>${userText}</div>`;
    chatEl.appendChild(userDiv);
  }
  if(botHTML){
    const botDiv = document.createElement("div");
    botDiv.className="bot-msg";
    botDiv.innerHTML = botHTML;
    chatEl.appendChild(botDiv);
  }
  chatEl.scrollTop = chatEl.scrollHeight;
}

// メイン処理
function handleInput(){
  const inputEl = document.getElementById("input");
  const text = inputEl.value.trim();
  if(!text) return;

  addChat(text,null);

  const hits = searchFAQ(text);
  if(hits.length===0){
    addChat(null,"<div>すみません、よくわかりません。キーワードを変えてみてください。</div>");
  } else {
    let html = "<div>候補を選んでください:</div>";
    hits.forEach(d=>{
      html += `<button class="button-option">${d.question}</button>`;
    });
    addChat(null, html);

    // ボタン押下で回答表示
    setTimeout(()=>{ // 少し遅延させてボタンにイベント付与
      document.querySelectorAll(".button-option").forEach((btn,i)=>{
        btn.onclick=()=>{
          addChat(null,`<div><strong>Q:</strong> ${hits[i].question}<br><strong>A:</strong> ${hits[i].answer}</div>`);
        };
      });
    },100);
  }

  inputEl.value="";
}

document.getElementById("sendBtn").addEventListener("click",handleInput);
document.getElementById("input").addEventListener("keypress", e=>{if(e.key==="Enter") handleInput();});

</script>
</body>
</html>
