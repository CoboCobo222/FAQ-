<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EPSON FAQ ChatBotï¼ˆå€™è£œãƒœã‚¿ãƒ³ç‰ˆï¼‰</title>

<script src="https://unpkg.com/kuroshiro/dist/kuroshiro.min.js"></script>
<script src="https://unpkg.com/kuroshiro-analyzer-kuromoji/dist/kuroshiro-analyzer-kuromoji.min.js"></script>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin:0; padding:16px; background:#fff; }
h3 { text-align:center; margin-bottom:12px; }

#inputArea { display:flex; gap:8px; margin-bottom:10px; }
#inputArea input { flex:1; padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc; }
#inputArea button { width:100px; padding:12px; font-size:16px; border:none; border-radius:8px; background:#007bff; color:#fff; }

#chat { height:70vh; overflow-y:auto; padding:10px; border:1px solid #ccc; border-radius:8px; background:#f7f7f7; }

.user-msg { text-align:right; margin:8px 0; }
.user-msg div { display:inline-block; background:#007bff; color:#fff; padding:8px 12px; border-radius:12px; }

.bot-msg { text-align:left; margin:8px 0; }
.bot-msg div { display:inline-block; background:#eee; color:#000; padding:8px 12px; border-radius:12px; margin-bottom:6px; }
.bot-msg .follow { font-size:12px; color:#555; margin-top:4px; }

.button-option { margin:4px 0; padding:6px 10px; border:none; border-radius:6px; background:#d0d0d0; cursor:pointer; }
.button-option:hover { background:#bbb; }
</style>
</head>
<body>

<h3>EPSON FAQ ChatBot</h3>

<div id="inputArea">
  <input id="input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦">
  <button id="sendBtn">é€ä¿¡</button>
</div>

<div id="chat"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1sq7O054J_6oiP-fkfCP5VCBjlgrjLMT9aXSev1ne6UE/gviz/tq?tqx=out:csv";
let data = [];
let kuro;

async function initKuro() { kuro = new Kuroshiro(); await kuro.init(new KuroshiroAnalyzerKuromoji()); }
initKuro();

fetch(CSV_URL).then(r=>r.text()).then(text=>{
  const lines=text.trim().split("\n").slice(1);
  data = lines.map(line=>{
    const cols=line.split(",").map(c=>c.replace(/^"|"$/g,""));
    const [category, question, answer, follow_up] = cols;
    return { category, question, answer, follow_up };
  });
});

function normalizeLatin(str){ return str.toLowerCase().normalize("NFKC").replace(/[ãƒ¼ï¼]/g,"ãƒ¼"); }

async function convertToHira(str){
  if(!str) return "";
  let tmp = normalizeLatin(str);
  try{ tmp = await kuro.convert(tmp,{to:"hiragana", mode:"spaced"}); }
  catch(e){ console.warn("å¤‰æ›ã‚¨ãƒ©ãƒ¼", e); }
  return tmp.replace(/\s+/g,"");
}

async function search(){
  const inputEl = document.getElementById("input");
  const chatEl = document.getElementById("chat");
  const question = inputEl.value.trim();
  if(!question) return;

  // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼å¹ãå‡ºã— ---
  const userDiv = document.createElement("div");
  userDiv.className="user-msg";
  userDiv.innerHTML=`<div>${question}</div>`;
  chatEl.appendChild(userDiv);

  // --- æ¤œç´¢ ---
  const normWords = (await convertToHira(question)).split(/\s+/);
  const hits = [];
  for(const d of data){
    const text = await convertToHira(d.category + d.question + d.answer + (d.follow_up||""));
    if(normWords.every(w=>text.includes(w))) hits.push(d);
  }

  // --- Botå¹ãå‡ºã— ---
  const botDiv = document.createElement("div");
  botDiv.className="bot-msg";

  if(hits.length===0){
    botDiv.innerHTML=`<div>è©²å½“ã™ã‚‹FAQãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚</div>`;
  } else {
    botDiv.innerHTML="<div>å€™è£œã‚’é¸ã‚“ã§ãã ã•ã„:</div>";
    hits.forEach((d,index)=>{
      const btn = document.createElement("button");
      btn.className="button-option";
      btn.textContent=d.question;
      btn.addEventListener("click",()=>{
        const answerDiv=document.createElement("div");
        answerDiv.className="bot-msg";
        answerDiv.innerHTML=`<div><strong>Q:</strong> ${d.question}<br><strong>A:</strong> ${d.answer}${d.follow_up?`<div class='follow'>ğŸ’¡ ${d.follow_up}</div>`:""}</div>`;
        chatEl.appendChild(answerDiv);
        chatEl.scrollTop = chatEl.scrollHeight;
      });
      botDiv.appendChild(btn);
    });
  }

  chatEl.appendChild(botDiv);
  chatEl.scrollTop = chatEl.scrollHeight;
  inputEl.value="";
}

document.getElementById("sendBtn").addEventListener("click", search);
document.getElementById("input").addEventListener("keypress", e=>{ if(e.key==="Enter") search(); });

</script>

</body>
</html>

